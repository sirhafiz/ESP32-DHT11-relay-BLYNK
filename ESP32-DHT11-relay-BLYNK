#define BLYNK_TEMPLATE_ID "TMPLxxxxxxxxxxxxxx"
#define BLYNK_TEMPLATE_NAME "Auto Relay Suhu"
#define BLYNK_AUTH_TOKEN "xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"

#include <WiFi.h>
#include <BlynkSimpleEsp32.h>
#include <DHT.h>

#define DHTPIN 4
#define DHTTYPE DHT11
#define RELAY_PIN 18

char ssid[] = "HafizTM 2.4GHz";
char pass[] = "h@f1z5335";

DHT dht(DHTPIN, DHTTYPE);

bool relayAuto = true;  // Auto mode mula

BLYNK_WRITE(V2) {  // V2 untuk switch manual/auto
  relayAuto = param.asInt();
  Serial.print("Mode: ");
  Serial.println(relayAuto ? "AUTO" : "MANUAL");
}

BLYNK_WRITE(V3) {  // V3 untuk force ON/OFF kalau manual
  if (!relayAuto) {
    int status = param.asInt();
    digitalWrite(RELAY_PIN, status ? LOW : HIGH);
    Serial.print("Relay MANUAL: ");
    Serial.println(status ? "ON" : "OFF");
  }
}

void setup() {
  Serial.begin(115200);
  delay(1000);
  Serial.println("ESP32 + DHT11 + Relay + Blynk Siap!");

  dht.begin();
  pinMode(RELAY_PIN, OUTPUT);
  digitalWrite(RELAY_PIN, HIGH);  // OFF mula

  Blynk.begin(BLYNK_AUTH_TOKEN, ssid, pass);
}

void loop() {
  Blynk.run();

  float suhu = dht.readTemperature();
  float kelembapan = dht.readHumidity();

  if (isnan(suhu) || isnan(kelembapan)) {
    Serial.println("Gagal baca DHT11!");
    delay(2000);
    return;
  }

  Blynk.virtualWrite(V0, suhu);
  Blynk.virtualWrite(V1, kelembapan);

  if (relayAuto) {
    if (suhu > 30) {
      digitalWrite(RELAY_PIN, LOW);  // ON
    } else {
      digitalWrite(RELAY_PIN, HIGH); // OFF
    }
  }

  Serial.print("Suhu: "); Serial.print(suhu); Serial.print(" Â°C | ");
  Serial.print("Relay: "); Serial.println(digitalRead(RELAY_PIN) == LOW ? "ON" : "OFF");

  delay(2000);
}
